---
title: Vite 和 Webpack
tag:
  - javascript
date: 2024-03-15
---

## 打包

现在常用的构建工具如 Webpack，主要是通过抓取-编译-构建整个应用的代码（也就是常说的打包过程），生成一份编译、优化后能良好兼容各个浏览器的的生产环境代码。在开发环境流程也基本相同，需要先将整个应用构建打包后，再把打包后的代码交给 dev server（开发服务器）。

Webpack 等构建工具的诞生给前端开发带来了极大的便利，但随着前端业务的复杂化，js 代码量呈指数增长，打包构建时间越来越久，dev server（开发服务器）性能遇到瓶颈：

## vite 为什么快

先介绍以下文中会经常提到的一些基础概念：

- 依赖： 指开发不会变动的部分（npm 包、UI 组件库），esbuild 进行预构建。
- 源码： 浏览器不能直接执行的非 js 代码（.jsx、.css、.vue 等），vite 只在浏览器请求相关源码的时候进行转换，以提供 ESM 源码。

### 开发模式

- 利用浏览器原生的 ES Module 支持能力，省略费时的编译环节，直给浏览器开发环境源码，dev server 只提供轻量服务。
- 浏览器执行 ESM 的 import 时，会向 dev server 发起该模块的 ajax 请求，服务器对源码做简单处理后返回给浏览器。
- Vite 中 HMR 是在原生 ESM 上执行的。当编辑一个文件时，Vite 只需要精确地使已编辑的模块失活，使得无论应用大小如何，HMR 始终能保持快速更新。
- 使用 esbuild 处理项目依赖，esbuild 使用 go 编写，比一般 node.js 编写的编译器快几个数量级。
- 充分利用 HTTP 的缓存机制，依赖（不会变动的代码）部分用 max-age,immutable 强缓存，源码部分用 304 协商缓存，提升页面打开速度。同时，还有文件系统缓存： Vite 在预构建阶段，将构建后的依赖缓存到 `node_modules/.vite`，相关配置更改时，或手动控制时才会重新构建，以提升预构建速度。
