---
title: JavaScript 首屏性能优化
tag:
  - javascript
  - interview_question
date: 2024-03-16
---

我这里提到的性能优化是指首页性能优化（first contentful paint）

主要是从一下两个方面

1. 网络请求优化
1. 代码执行优化

## 网络请求优化

这里又可以分为几个方面

1. 资源大小优化
1. 请求次数优化
1. 响应时间优化
1. 加载方式优化

### 资源大小优化

我们可以使用图片压缩，代码压缩，Gzip 等手段来减少请求的资源大小，同时还能减少服务器负担

### 请求次数优化

对于很多的小文件，我们可以使用合并资源文件（雪碧图，合并 js，css 文件）来减少请求次数

同时，还可以使用更先进的 HTTP 协议版本（HTTP/2）他的多路复用可以减少请求次数

同时，设置合适的缓存策略也可以减少请求的次数（比如 HTTP 强缓存，server worker）

### 响应时间优化

用户端可以设置 DNS 预解析，减少 DNS 查询时间

服务器端可以使用 CDN 来减少请求的响应时间（减少请求之间的跳数）

### 加载方式优化

可以使用按需加载，懒加载等方式减少首屏加载资源请求数

## 代码执行优化

这里可以通过对 HTML，CSS，JS 进行优化来减少首屏加载时间

### HTML 优化

通过减小 HTML 文件大小，尽量将框架代码减小到 14KB 以内，减少首屏加载时间

对于外部资源的位置，CSS 放在 head 标签中，JS 放在 body 标签底部，可以减少首屏加载时间

::: tip
在讨论HTML文件大小应当尽量保持在14KB以内的原理时，我们首先需要理解HTTP和浏览器加载页面的一些背景知识。

当浏览器请求一个网页时，首先它会发起一个HTTP请求。HTTP协议在传输数据时使用了一种叫做TCP（传输控制协议）的协议。在TCP连接建立时，会有一个叫做“慢启动”的过程。

“慢启动”协议是用来控制数据包的传输，以防止网络拥堵。在TCP连接刚建立的时候，慢启动协议限制了初始的数据传输速率。随着连接的继续，如果网络条件良好，这个速率将会逐渐提高。

这里的关键是，在很多情况下，TCP的初始窗口大小（也就是一开始允许传输的数据量）大约是14KB。所以，如果你的HTML文件大小刚好在14KB以内，那么在TCP连接建立后，整个HTML文件就可以在第一次的数据传输中就被接收完毕。这意味着浏览器可以更早地开始解析HTML，从而更早地开始加载CSS和JavaScript文件，进而更早地渲染页面。这对于提升网页的首次渲染速度（First Paint）和首次内容绘制（First Contentful Paint）非常有帮助。

所以，尽管这并不是一个严格的规则，但是如果可能，将HTML文件大小控制在14KB以内是一个很好的实践，可以帮助提高网页加载的性能。
:::

### CSS 优化

尽量减少复杂选择器的使用

图片的样式应当尽量设置，避免出现图片的回流，导致页面重新渲染

合理使用 `transform` 和 `opacity` 来优化动画效果，因为可以触发 GPU 加速（分层合成）

### JS 优化

动画效果尽量使用 CSS3 动画，避免使用 JS 动画，或者使用 requestAnimationFrame 来优化动画效果

对于一些复杂的计算，可以使用 web worker 来进行计算，避免阻塞主线程
