---
title: 浏览器中的进程和线程
tag:
  - browser
date: 2024-01-07
---

## 什么是进程和线程

### 定义

进程是资源分配的最小单位，线程是操作系统调度的最小单位

线程是进程中的一个实体，每个进程可以包含多个线程，线程只拥有一点必不可少的运行资源 (如程序计数器，一组寄存器和栈)，但是同一个进程中的多个线程之间可以共享其他资源 (如内存地址空间，文件句柄等)

### 区别

- 进程是资源分配的最小单位，线程是操作系统调度的最小单位
- 进程拥有独立的地址空间，线程没有独立的地址空间，线程间共享进程的地址空间
- 进程间不会相互影响，一个线程挂掉将导致整个进程挂掉 (因为线程间共享进程的地址空间)
- 切换进程时，因为涉及到切换地址空间等，开销比较大，而线程切换时，只需要保存一些寄存器的内容 (PC，SP 等)，开销比较小

### 进程之间的通信方式 IPC

1. 共享内存，这是最快的一种方式，但是会遇到同步问题，所以需要一些同步机制来保证数据一致性，Linux中有专门的函数用来创建共享内存
1. 消息队列，实际上是内核空间中的一个缓冲区，发送方将消息放入队列，接收方从队列中读取消息。消息队列可以实现异步通信和解耦，但需要定义消息格式和处理机制。
1. 管道，管道是半双工的，数据只能在一个方向上流动，需要双方通信时，需要建立起两个管道，而且只能在具有亲缘关系的进程间使用
1. 套接字，是一个全双工的同时方式，可以在同一个主机或者不同的主机的不同进程之间进行通信
1. 文件和管道，一个进程将内容写入到文件或者管道中，另一个进程从文件或者管道中读取内容

## 浏览器中的进程和线程

浏览器本身是多进程和多线程的

其进程分为以下几类

1. 浏览器主进程，唯一，其主要负责创建和销毁其他进程，浏览器界面展示，网络资源下载等
1. GPU 进程，唯一，其主要负责 3D 绘制等
1. 浏览器渲染进程，多个，每打开一个网页就会创建一个渲染进程，其主要负责页面渲染，脚本执行，事件处理等
1. 插件进程，多个，仅当使用时创建，多个页面共享一个插件进程
1. 网络请求进程，有可能和第一个重复 (目前暂不清楚)

<!-- TODO: 真的只有这些进程吗 -->

这里主要介绍渲染进程的线程，其分为以下几类，以 Chrome 为例

1. GUI 渲染线程，负责渲染浏览器界面，解析 HTML，CSS，构建 DOM 树和 RenderObject 树，布局和绘制等。当浏览器需要重绘或者回流时，该线程就会执行
1. JS 引擎线程，负责解析 JavaScript 脚本，运行代码，例如 V8 引擎
1. 事件触发线程，每当事件触发时，该线程就会把事件添加到待 JS 引擎线程的处理队列的队尾，等待引擎线程的处理
1. 异步 HTTP 请求线程

<!-- TODO: 渲染进程的异步 HTTP 请求线程究竟在做什么 -->

其中 GUI 渲染线程和 JS 引擎线程互斥，当 JS 引擎线程执行时 GUI 渲染线程会被挂起，GUI 渲染线程执行时 JS 引擎线程会被挂起，所以 JS 执行时间过长会导致页面渲染不连贯

**所以 JavaScript 中单线程就是指 JS 引擎线程**

### web worker

为此 HTML5 提出了 Web Worker 标准，浏览器在原始页面环境之外再分配一个完全独立的二级子环境，这个子环境不能与依赖单线程交互的 API (如 DOM) 进行交互，但是可以与父环境并行执行代码

工作者线程有三种类型

1. 专用工作者线程
1. 共享工作者线程
1. 服务工作者线程

其内容不再赘述,参考 [MDN web worker](https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Workers_API/Using_web_workers)

工作者线程是通过操作系统中的线程进行实现的，但是他们还是有一些区别和限制

1. 只能共享部分内存，只能操作 SharedArrayBuffer，除此之外的数据进出都需要复制和转移
1. 工作者线程不一定在同一个进程中，比如 Chrome 的 blink 引擎，共享工作者和服务工作者线程都是在独立的进程中
1. 工作者线程创建的开销更大，因为有自己独立的事件循环和全局对象，事件处理程序等，创建会有比较高的代价

## 参考

[小墨鱼的面试笔记](https://cchroot.github.io/interview/pages/interview%20notes/%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B8%8ENode%E7%9A%84%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AFEvent%20Loop.html#%E8%BF%9B%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B)

[MDN web worker](https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Workers_API/Using_web_workers)

JavaScript 高级程序设计 p791
