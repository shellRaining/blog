---
title: 从 URL 到渲染结束
tag:
  - browser
  - interview_question
date: 2024-03-06
---

## 导航

### DNS 查询

我们输入域名后并按下回车的时候，就会首先去解析域名为 IP 地址，这个过程需要进行 DNS 查询

浏览器向名称服务器发起 DNS 查询请求，最终得到一个 IP 地址。第一次请求之后，这个 IP 地址可能会被缓存一段时间，这样可以通过从缓存里面检索 IP 地址而不是再通过名称服务器进行查询来加速后续的请求。

::: warning
通过主机名加载一个页面通常仅需要一次 DNS 查询。但是，对于页面指向的不同的主机名，则需要多次 DNS 查询。如果字体（font）、图像（image）、脚本（script）、广告（ads）和网站统计（metric）都有不同的主机名，则需要对每一个主机名进行 DNS 查询。

但是在上面描述的时间点，我们还没有获取页面信息，所以不会涉及到多次查询 DNS
:::

### TCP 握手

获取到 IP 地址之后，我们的主机便会向目标服务器发送 TCP 握手请求（来建立连接）

TCP 的“三次握手”技术经常被称为 SYN、SYN-ACK、ACK

::: info
握手挥手问题可以看 [TCP 三次握手，四次挥手](../net/tcp_handshake.md)
:::

::: warning
对于通过 HTTPS 建立的安全连接，还需要另一次 "握手"。这种握手，或者说 TLS 协商，决定使用哪种密码对通信进行加密，验证服务器，并在开始实际数据传输前建立安全连接
:::

经过这个过程后，一个 TCP 连接就建立起来了

## 响应

一旦我们建立了到 web 服务器的连接，浏览器就代表用户（所以说浏览器就是用户代理）发送一个初始的 HTTP GET 请求，对于网站来说，这个请求通常是一个 HTML 文件。一旦服务器收到请求，它将使用相关的响应头和 HTML 的内容进行回复。

初始请求的响应包含所接收数据的第一个字节。首字节时间（TTFB time to first byte）是用户通过点击链接进行请求与收到第一个 HTML 数据包之间的时间。第一个内容分块通常是 14KB 的数据。

::: info
这里还涉及到 TCP 的拥塞控制和慢启动算法，作为一个 TODO，留待未来
:::

## 解析

一旦浏览器收到数据的第一块，它就可以开始解析收到的信息。“解析”是浏览器将通过网络接收的数据转换为 DOM 和 CSSOM 的步骤

即使请求页面的 HTML 大于初始的 14KB 数据包，浏览器也将开始解析并尝试根据拥有的数据进行渲染。这就是为什么在前 14KB 中包含浏览器开始渲染页面所需的所有内容，或者至少包含页面模板（第一次渲染所需的 CSS 和 HTML）对于 web 性能优化来说是重要的。但是在渲染到屏幕上面之前，HTML、CSS、JavaScript 必须被解析完成。

::: info
这部分涉及到浏览器的进程和线程，可以看一下这个部分 [浏览器的进程和线程](./process_thread.md)
:::

### 构建 DOM 树

第一步是处理 HTML 标记并构造 DOM 树。HTML 标记包括开始和结束标记，以及属性名和值。

DOM 树描述了文档的内容。`<html>` 元素是第一个标签也是文档树的根节点。

<img width='' src='https://developer.mozilla.org/zh-CN/docs/Web/Performance/How_browsers_work/dom.gif'>

当解析器发现非阻塞资源，例如一张图片，浏览器会请求这些资源并且继续解析。当遇到一个 CSS 文件时，解析也可以继续进行，但是对于 `<script>` 标签（特别是没有 async 或者 defer 属性的）会阻塞渲染并停止 HTML 的解析。尽管浏览器的预加载扫描器加速了这个过程，但过多的脚本仍然是一个重要的瓶颈。

预加载扫描仪将解析可用的内容并请求高优先级资源，如 CSS、JavaScript 和 web 字体。

等待获取 CSS 不会阻塞 HTML 的解析或者下载，但是它确实会阻塞 JavaScript，因为 JavaScript 经常用于查询元素的 CSS 属性。

### 构建 CSSOM 树

CSSOM 和 DOM 是相似的，他们都是树结构。浏览器遍历 CSS 中的每个规则集，根据 CSS 选择器创建具有父、子和兄弟关系的节点树。

::: info
构建 CSSOM 非常快，并且在当前的开发工具中没有以独特的颜色显示。相反，开发人员工具中的“重新计算样式”显示解析 CSS、构建 CSSOM 树和递归计算计算样式所需的总时间。在 web 性能优化方面无须过多关注，因为创建 CSSOM 的总时间通常小于一次 DNS 查询所需的时间。
:::

### JavaScript 编译

在解析 CSS 和创建 CSSOM 的同时，包括 JavaScript 文件在内的其他资源也在下载（这要归功于预加载扫描器）。JavaScript 会被解析、编译和解释。脚本被解析为抽象语法树。有些浏览器引擎会将抽象语法树输入编译器，输出字节码。这就是所谓的 JavaScript 编译。大部分代码都是在主线程上解释的，但也有例外，例如在 web worker 中运行的代码。

## 渲染

渲染包含了样式，布局，绘制，也有可能涉及到合成。这个过程会将 DOM 树和 CSSOM 树合并成一个渲染树（或者叫作计算样式树）

### 样式计算

计算样式树（渲染树）的构建是从 DOM 树根节点开始的，遍历每一个*可见的*节点（比如不包括 `<head>` 标签，或者 `display: none`）

### 布局计算

在渲染树上运行布局计算，来确定渲染树中所有节点的宽度、高度和位置。回流是对页面的任何部分或整个文档的任何后续大小和位置的确定。

在此阶段，考虑到视口大小，浏览器将确定屏幕上所有不同框的尺寸。以视口的大小为基础，通常从 body 开始，用每个元素的盒模型属性排列所有 body 的子孙元素，为不知道其尺寸的替换元素（例如图像）提供占位符空间。

```html
<link rel="stylesheet" href="styles.css" />
<script src="myscript.js" async></script>
<img src="myimage.jpg" alt="图像描述" />
<script src="anotherscript.js" async></script>
```

第一次确定节点的大小和位置称为布局。随后对节点大小和位置的重新计算称为回流。在上面的示例中，假设初始布局发生在返回图像之前。由于我们没有声明图像的尺寸，因此一旦知道图像的尺寸，就会出现回流。

### 绘制

最后一步是将各个节点绘制到屏幕上，第一次出现的节点称为 `first meaningful paint`，绘制包括将元素的每个可视部分绘制到屏幕上，包括文本、颜色、边框、阴影和替换的元素（如按钮和图像）。浏览器需要非常快地完成这项工作。

为了确保平滑滚动和动画，浏览器必须在不到 16.67 毫秒内完成占用主线程的所有内容，包括计算样式、回流和绘制。为了确保重绘可以比初始绘制更快地完成，将屏幕上的绘图通常分解成几个图层。如果发生这种情况，则需要合成。

有一些特定的属性和元素可以实例化一个层，包括 `<video>` 和 `<canvas>`，任何 CSS 属性为 opacity 、3D transform 等元素。这些节点将与子节点一起绘制到它们自己的层上，除非子节点由于上述一个（或多个）原因需要自己的层。

### 合成

当文档的各个部分以不同的层绘制，相互重叠时，必须进行合成，以确保它们以正确的顺序绘制到屏幕上，并正确显示内容。

当页面继续加载资源时，可能会发生回流（如上面的例子），回流会触发重新绘制和重新合成。如果我们定义了图像的大小，就不需要重新绘制，只需要重新绘制某些层，并在必要时进行合成。但上面例子我们没有包括图像大小！从服务器获取图像后，渲染过程将返回到布局步骤并从那里重新开始。

## 交互

在我们的示例中，可能图像加载很快，但 `anotherscript.js` 文件可能是 2MB，而且用户的网络连接很慢。在这种情况下，用户可以非常快地看到页面，但是在下载、解析和执行脚本之前，就无法滚动。这不是一个好的用户体验。避免占用主线程

::: info
首次内容渲染（FCP）是指浏览器从 DOM 中呈现出第一部分内容，向用户提供页面实际加载的第一个反馈。

首次内容绘制时间戳是指浏览器首次呈现任何文本、图像（包括背景图像）、视频、画布中已绘制的内容或非空 SVG 的时间。这不包括任何 iframe 的内容，但包括待定网络字体的文本。
:::

## 参考

[https://developer.mozilla.org/zh-CN/docs/Web/Performance/How_browsers_work](https://developer.mozilla.org/zh-CN/docs/Web/Performance/How_browsers_work)
